## 🎯 콘서트 대기열 시스템 동시성 이슈 해결 방안 보고서

### 1. 동시성 제어를 위한 락 개요

- **낙관적 락 (Optimistic Lock)**  
  데이터 충돌 가능성이 낮다고 가정하고 트랜잭션 수행.  
  트랜잭션 종료 시점에 버전을 비교하여 충돌 여부를 판단.  
  충돌 시 롤백 처리. 성능상 이점이 있음.
- **비관적 락 (Pessimistic Lock)**  
  데이터 충돌 가능성이 높다고 가정하고, 자원 접근 시점에 락을 건다.  
  다른 트랜잭션은 락 해제 전까지 대기. 안정성은 높지만 성능 저하 가능.
---

### 2. 비즈니스 요구사항 및 동시성 이슈

#### 2-1. 시스템 개요
본 시스템은 콘서트 대기열 기반 예약 시스템으로, **다수의 고객이 동시에 좌석 예약 및 포인트 충전 요청을 수행**함. 이에 따라 자원 충돌 가능성이 높음.
#### 2-2. 요구사항
- **좌석 점유**: 하나의 좌석에 한 명만 예약 가능. 동시 요청 시, 1건만 성공, 나머지는 실패해야 함.
- **포인트 충전**: 동일 포인트 자원에 중복 충전이 발생하지 않아야 함. 동시에 여러 요청이 와도, 단 1회만 충전 처리되어야 함.
---

### 3. 적용 전략 및 테스트 결과

#### 3-1. 좌석 점유

- **적용 락**: 낙관적 락 (JPA @Version 활용)
- **초기 시도**: 비관적 락 사용 → 성공은 1건이지만, 999건의 실패 요청도 대기하여 전체 처리 시간이 5~8초 소요됨.
- **개선 적용**: 낙관적 락으로 전환 → 실패 요청이 대기 없이 빠르게 종료됨 → 사용자 재시도 유도 가능
- **결론**: 빠른 피드백과 성능 측면에서 낙관적 락이 적합
#### 3-2. 포인트 충전

- **적용 락**: 낙관적 락
- **요구사항**: 하나의 요청만 성공하고 나머지는 무조건 실패해야 함
- **비관적 락 사용 시**: 모든 요청이 순차적으로 처리되어 충전이 중복 발생 → 요구사항과 불일치
- **낙관적 락 사용 시**: 버전 충돌로 인해 중복 충전 없이 단 1건만 처리됨 → 요구사항 충족
- **결론**: 낙관적 락이 요구사항에 가장 적합

|전략|쓰레드풀|쓰레드 수|성공|실패|평균 응답 시간|
|---|---|---|---|---|---|
|낙관적 락|100|1000|340|660|150ms|
||10|1000|338|662|15ms|
||1000|1000|338|662|808ms|
|비관적 락|100|1000|1000|0|223ms|
||10|1000|1000|0|23ms|
||1000|1000|1000|0|1280ms|

---
### 4. 결론 및 적용 범위

|기능|요구사항 요약|적용 락|락 범위|
|---|---|---|---|
|좌석 점유|1좌석 1예약, 실패는 빠르게 처리되어야 함|낙관적 락|좌석 단위|
|포인트 충전|중복 없이 단 1건만 처리되어야 함|낙관적 락|사용자 포인트 단위|

- **비관적 락은 모든 요청 처리 보장이라는 장점이 있으나**, 본 시스템의 요구사항에서는 낙관적 락이 더 적합하다고 판단
- **락 범위는 최소화하여 성능을 고려해 설정함**